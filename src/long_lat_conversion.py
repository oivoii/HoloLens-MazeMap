import numpy as np
import os

R_e = 6378137
R_p = 6356752

R = 6371000

d2r = np.pi/180
r2d = 1/d2r

def N(lat):
    mu = d2r*lat
    a = R_e
    e = 1 - ((R_p**2)/(R_e**2))
    #return (R_e^2)/((R_e^2)*np.cos(mu)*np.cos(mu) + (R_p^2)*np.sin(mu)*np.sin(mu))
    return a/(np.sqrt(1-(e**2)*sin(mu)**2))

def coor_to_ECEF(longd, lat, h=44):
    mu = lat*d2r
    l = longd*d2r
    x = (N(mu) + h)*np.cos(mu)*np.cos(l)
    y = (N(mu) + h)*np.cos(mu)*np.sin(l)
    z = (((R_p**2)/(R_e**2)*N(mu) + h)*np.sin(mu))
    ECEF = np.array([x,y,z])
    return ECEF


def ECEF_to_NED(longd, lat, ECEF_vec):
    mu = d2r*lat
    l = d2r*longd

    Rot_matrix = np.array([[-np.cos(l)*np.sin(mu), -np.sin(l), -np.cos(l)*np.cos(mu)],
                           [-np.sin(l)*np.sin(mu), np.cos(l), -np.sin(l)*np.cos(mu)],
                           [np.cos(mu), 0, -np.sin(mu)]])
    
    NED_vec = Rot_matrix.dot(ECEF_vec)
    return NED_vec

def NED_to_BODY(NED_vec, r = 0):
    #r=0 for facing north at initialization
    #INITIAL Body fixed has positive z down
    r = d2r*r
    R_x = np.array([[1, 0, 0], [0, np.cos(r), -np.sin(r)], [0, np.sin(r), np.cos(r)]])
    #R_z = np.array([[np.cos(r), -np.sin(r), 0], [np.sin(r), np.cos(r), 0], [0, 0, 1]])
    BODY_vec = R_x.dot(NED_vec)
    return BODY_vec

def BODY_to_UNITY(BODY_vec):
    x,y,z = 0,1,2
    UNITY_coordinates = [0,0,0]
    UNITY_coordinates[x] = BODY_vec[y]
    UNITY_coordinates[y] = BODY_vec[-z]
    UNITY_coordinates[z] = BODY_vec[x]
    return UNITY_coordinates

def coor_to_UNITY(ECEF_initial, longd, lat):
    ECEF = coor_to_ECEF(longd, lat)
    print("ECEF: {}".format(ECEF))
    ECEF_relative = ECEF - ECEF_initial  
    print("ECEF relative: {}".format(ECEF_relative))
    NED = ECEF_to_NED(longd, lat, ECEF_relative)
    print("NED : {}".format(NED))
    BODY = NED_to_BODY(NED)
    print("BODY: {}".format(BODY))
    UNITY = BODY_to_UNITY(BODY)
    print("UNITY: {}".format(UNITY))
    return UNITY

def haversine(longd_1, lat_1, longd_2, lat_2):
    l1 = longd_1*d2r
    mu1 = lat_1*d2r
    l2 = longd_2*d2r
    mu2 = lat_2*d2r

    dl = l2-l1
    dmu = mu2-mu1
    """
    a = (np.sin(dmu/2)**2) + np.cos(mu1)*np.cos(mu2) + (np.sin(dl/2)**2)
    c = 2* np.arctan2(np.sqrt(a), np.sqrt(1-a))
    distance = R*c
    """
    distance = np.arccos( np.sin(mu1)*np.sin(mu2) + np.cos(mu1)*np.cos(mu2)*np.cos(dl)) * R

    print("Distance: {} m".format(distance))

    y = np.sin(dl) * np.cos(mu2)
    x = np.cos(mu1) * np.sin(mu2) - np.sin(mu1)*np.cos(mu2)*np.cos(dl)

    bearing = np.arctan2(y, x)*r2d

    print("Bearing: {} degrees".format(bearing))

    return distance, bearing


if __name__ == "__main__":

    #init_long, init_lat = 10.406653822839438, 63.415982592345294
    #test_long, test_lat = 10.4, 63.4

    length_per_x = R_e/45

    init_lat, init_long = 63.414949, 10.398124
    test_lat, test_long = 63.427648, 10.392999
    #ca 1,4 km unna hverandre

    haversine(init_long, init_lat, test_long, test_lat)

    """
    init_ECEF = coor_to_ECEF(init_lat, init_long)
    unity = coor_to_UNITY(init_ECEF, test_lat, test_long)

    
    R1 =          [[[10.406653822839438, 63.415982592345294], [10.406659705408844, 63.4159738220273], [10.406663836523906, 63.415965521456314], [10.406666459472277, 63.415956901970794], [10.40666758041516, 63.41594851433478], [10.406667266384321, 63.415939616934885], [10.406662434241664, 63.41590099082312], [10.406639241411877, 63.415896229589926], [10.406660061783553, 63.415876398492436], [10.406632331211242, 63.41587070675064], [10.406650634889909, 63.41585326708068], [10.406467550740407, 63.415815722486535], [10.40644915751432, 63.41583322670944], [10.40642141940069, 63.415827543074975], [10.406400663168842, 63.41584730706515], [10.40637746284996, 63.41584255392341], [10.406307595479923, 63.415865863478714], [10.406292307814205, 63.41587137733963], [10.406279578271166, 63.41587667195967], [10.406269013039063, 63.41588172537715], [10.406253663689235, 63.41589030803744], [10.406241583182178, 63.41589855931849], [10.406234367311098, 63.415904232709416], [10.40622963241374, 63.4159085921427], [10.406225072028409, 63.41591317077492], [10.406220766660159, 63.41591814867465], [10.406216375986537, 63.415924149525814], [10.406215295245715, 63.41592586113311], [10.406221845698242, 63.4159291712555], [10.406218851681512, 63.41593030322986], [10.406210873170782, 63.415926260163964], [10.406212087996945, 63.41592430046956], [10.406179608346989, 63.41591764604054], [10.40613213468479, 63.415962858152746], [10.406151538535928, 63.415966843311], [10.406149629803743, 63.41596886148476], [10.406175459129528, 63.415974157989226], [10.406176397801293, 63.41597338661484], [10.40617865974134, 63.41597384802107], [10.406225085262019, 63.415952377330804], [10.406230935769182, 63.41595484560423], [10.406228219005902, 63.4159560997373], [10.40622690645949, 63.41595557572052], [10.406168271958627, 63.41598264352578], [10.40618283917441, 63.415988547003245], [10.406209876924326, 63.415998564626015], [10.406222653558048, 63.41600300633894], [10.406236001434994, 63.41600735306168], [10.40627898466891, 63.416020032210035], [10.406302792591521, 63.41602616728846], [10.406347279109855, 63.41603621495128], [10.406363382686965, 63.416039372376225], [10.406410431493105, 63.41604749343422], [10.406434258174993, 63.41605092569445], [10.40647131107456, 63.41605539311157], [10.406489484213347, 63.41605722073527], [10.406507252417972, 63.416058791868245], [10.406535822896208, 63.41606092896854], [10.406555412442883, 63.4160620355925], [10.406555434795646, 63.41606202764316], [10.406564343225687, 63.41602477005485], [10.406562590354241, 63.41602466511546], [10.406563003316665, 63.416022938776436], [10.406571046389434, 63.4160233194166], [10.406563913380685, 63.41605334142503], [10.406565363085688, 63.41605411080824], [10.406591278985665, 63.416059424858226], [10.406593535704594, 63.41605747805113], [10.406612953860945, 63.4160614511088], [10.406660401322195, 63.416016236703186], [10.406627961405789, 63.41600957845737], [10.406625352463715, 63.41601125229554], [10.406613214370859, 63.41601117034962], [10.406613240857451, 63.416009431139194], [10.406623186639175, 63.41600950268644], [10.406629008352446, 63.41600558251171], [10.40663518936333, 63.416000980058875], [10.406639989572144, 63.415997029113065], [10.40664631949023, 63.415991000759824], [10.406653822839438, 63.415982592345294]],
                        [[10.406647478829607, 63.415911335358665], [10.406647740579446, 63.41591091953988], [10.406647693073444, 63.4159104889677], [10.406648237593586, 63.4159101341562], [10.40664850190624, 63.41590971865664], [10.40664927675497, 63.41590945663503], [10.406649826261848, 63.41590909980064], [10.406650755728688, 63.415908956243], [10.406651536618506, 63.41590869301053], [10.406652529802818, 63.415908682018774], [10.406653465749706, 63.41590853813174], [10.40665442521067, 63.41590866083599], [10.406655424485677, 63.41590865039451], [10.406656261834865, 63.41590889592303], [10.406657221193502, 63.415909018828266], [10.406657848380974, 63.41590936277999], [10.40665867971769, 63.41590960728196], [10.406659035446205, 63.415910016018735], [10.406659657497917, 63.41591035816235], [10.40665970689509, 63.41591079163164], [10.406660058823686, 63.41591119784376], [10.406659797070484, 63.41591161366784], [10.406659844576497, 63.415912044239995], [10.406659300056353, 63.415912399051464], [10.406659035743699, 63.415912814551], [10.40665826089497, 63.41591307657257], [10.406657711395061, 63.415913433402366], [10.406656781921109, 63.41591357696455], [10.406656000994953, 63.41591384020928], [10.406655007838983, 63.41591385119664], [10.406654071936048, 63.4159139950803], [10.406653112439269, 63.41591387237149], [10.40665211315084, 63.415913882809015], [10.406651275815074, 63.41591363728448], [10.406650316471907, 63.41591351438126], [10.406649689268974, 63.4159131704276], [10.406648857901194, 63.41591292591653], [10.406648502195264, 63.41591251719678], [10.406647880154267, 63.41591217506561], [10.406647830754913, 63.41591174157613], [10.406647478829607, 63.415911335358665]],
                        [[10.406597513360365, 63.41595892050448], [10.406597775110207, 63.41595850468638], [10.406597727604202, 63.415958074114926], [10.406598272124347, 63.41595771930401], [10.406598536437002, 63.41595730380512], [10.40659931128573, 63.415957041783955], [10.40659986079262, 63.415956684950174], [10.406600790259446, 63.415956541392774], [10.406601571149238, 63.415956278160756], [10.40660256433358, 63.415956267169], [10.406603500280513, 63.41595612328221], [10.40660445974143, 63.41595624598625], [10.406605459016403, 63.4159562355448], [10.406606296365625, 63.415956481072904], [10.406607255724305, 63.41595660397793], [10.406607882911734, 63.41595694792908], [10.406608714248422, 63.41595719243064], [10.406609069976966, 63.41595760116676], [10.40660969202868, 63.4159579433098], [10.40660974142585, 63.41595837677835], [10.406610093354445, 63.4159587829898], [10.406609831601253, 63.41595919881319], [10.406609879107256, 63.41595962938464], [10.406609334587113, 63.415959984195524], [10.40660907027446, 63.415960399694356], [10.406608295425729, 63.4159606617155], [10.40660774592583, 63.41596101854469], [10.40660681645187, 63.41596116210663], [10.406606035525698, 63.41596142535094], [10.406605042369742, 63.41596143633828], [10.406604106466817, 63.415961580221705], [10.40660314697003, 63.41596145751309], [10.406602147681593, 63.4159614679506], [10.406601310345835, 63.41596122242649], [10.406600351002686, 63.41596109952346], [10.406599723799737, 63.41596075557036], [10.406598892431946, 63.4159605110597], [10.406598536726024, 63.41596010234065], [10.406597914685028, 63.41595976021005], [10.406597865285674, 63.415959326721286], [10.406597513360365, 63.41595892050448]],
                        [[10.406542088325002, 63.41600826430355], [10.406544654006565, 63.4160000328801], [10.40659014647692, 63.416002341020665], [10.40658919889155, 63.41601065271259], [10.406586744662194, 63.41601057342709], [10.406587672666026, 63.416003140895185], [10.406587644066263, 63.41600312281429], [10.40654679883311, 63.41600105037295], [10.406546754789106, 63.41600106572327], [10.406544459757392, 63.416008428600726], [10.406542088325002, 63.41600826430355]],
                        [[10.406547547891126, 63.41600650557134], [10.40654780964097, 63.4160060897539], [10.406547762134965, 63.41600565918317], [10.40654830665511, 63.41600530437285], [10.406548570967761, 63.41600488887465], [10.40654934581649, 63.41600462685392], [10.40654989532338, 63.41600427002072], [10.406550824790207, 63.41600412646356], [10.40655160567999, 63.41600386323198], [10.406552598864339, 63.416003852240244], [10.4065535348113, 63.416003708353685], [10.40655449427219, 63.41600383105751], [10.406555493547145, 63.41600382061609], [10.406556330896386, 63.41600406614379], [10.406557290255067, 63.41600418904862], [10.406557917442495, 63.416004532999196], [10.406558748779194, 63.41600477750035], [10.406559104507725, 63.41600518623579], [10.406559726559447, 63.416005528378264], [10.406559775956618, 63.416005961846096], [10.406560127885205, 63.41600636805688], [10.406559866132014, 63.41600678387958], [10.406559913638016, 63.41600721445031], [10.406559369117874, 63.4160075692606], [10.40655910480524, 63.41600798475875], [10.406558329956491, 63.416008246779455], [10.406557780456573, 63.41600860360805], [10.40655685098263, 63.41600874716976], [10.406556070056483, 63.41600901041361], [10.406555076900505, 63.41600902140095], [10.40655414099757, 63.41600916528412], [10.40655318150079, 63.416009042575716], [10.40655218221236, 63.4160090530132], [10.406551344876595, 63.41600880748949], [10.406550385533427, 63.41600868458668], [10.406549758330497, 63.416008340634164], [10.406548926962726, 63.41600809612391], [10.406548571256785, 63.416007687405525], [10.406547949215799, 63.41600734527548], [10.406547899816433, 63.416006911787456], [10.406547547891126, 63.41600650557134]],
                        [[10.406497582421887, 63.41605409055919], [10.406497844171737, 63.416053674742464], [10.406497796665725, 63.416053244172446], [10.406498341185877, 63.4160528893627], [10.406498605498522, 63.41605247386521], [10.40649938034726, 63.4160522118449], [10.406499929854157, 63.41605185501229], [10.406500859320968, 63.416051711455374], [10.406501640210731, 63.41605144822423], [10.4065026333951, 63.41605143723251], [10.40650356934206, 63.41605129334621], [10.406504528802952, 63.416051416049825], [10.406505528077933, 63.416051405608414], [10.406506365427147, 63.4160516511357], [10.406507324785801, 63.41605177404033], [10.406507951973255, 63.41605211799033], [10.406508783309963, 63.4160523624911], [10.406509139038485, 63.41605277122585], [10.406509761090208, 63.41605311336776], [10.40650981048738, 63.41605354683487], [10.406510162415968, 63.41605395304497], [10.406509900662773, 63.41605436886699], [10.406509948168786, 63.416054799437006], [10.406509403648633, 63.4160551542467], [10.406509139335999, 63.41605556974416], [10.406508364487252, 63.41605583176443], [10.406507814987343, 63.41605618859243], [10.406506885513389, 63.4160563321539], [10.406506104587226, 63.41605659539734], [10.406505111431265, 63.416056606384636], [10.406504175528339, 63.416056750267586], [10.40650321603156, 63.41605662755938], [10.406502216743112, 63.41605663799685], [10.406501379407356, 63.41605639247356], [10.406500420064207, 63.416056269570944], [10.406499792861256, 63.41605592561898], [10.406498961493474, 63.41605568110913], [10.406498605787545, 63.416055272391425], [10.406497983746558, 63.41605493026196], [10.406497934347193, 63.41605449677465], [10.406497582421887, 63.41605409055919]],
                        [[10.406359009684722, 63.41585218229512], [10.406359271434564, 63.41585176647547], [10.406359223928552, 63.4158513359024], [10.406359768448704, 63.41585098109018], [10.406360032761349, 63.41585056558974], [10.406360807610087, 63.41585030356761], [10.406361357116973, 63.41584994673248], [10.406362286583795, 63.41584980317455], [10.406363067473587, 63.41584953994156], [10.406364060657925, 63.415849528949764], [10.406364996604886, 63.41584938506242], [10.406365956065779, 63.41584950776693], [10.406366955340733, 63.41584949732542], [10.406367792689982, 63.415849742854455], [10.406368752048662, 63.41584986575996], [10.406369379236091, 63.41585020971238], [10.406370210572788, 63.41585045421485], [10.40637056630131, 63.415850862952475], [10.406371188353033, 63.4158512050968], [10.406371237750207, 63.41585163856696], [10.406371589678791, 63.41585204477993], [10.406371327925601, 63.41585246060486], [10.406371375431611, 63.41585289117792], [10.40637083091146, 63.415853245990114], [10.406370566598808, 63.415853661490516], [10.406369791750079, 63.415853923512614], [10.406369242250186, 63.41585428034314], [10.406368312776218, 63.41585442390563], [10.406367531850062, 63.41585468715089], [10.406366538694092, 63.41585469813828], [10.406365602791166, 63.41585484202223], [10.406364643294387, 63.41585471931317], [10.406363644005948, 63.41585472975072], [10.406362806670183, 63.41585448422569], [10.406361847327023, 63.4158543613222], [10.406361220124083, 63.41585401736783], [10.406360388756312, 63.415853772856266], [10.40636003305038, 63.415853364135685], [10.406359411009385, 63.41585302200379], [10.40635936161002, 63.41585258851344], [10.406359009684722, 63.41585218229512]],
                        [[10.406309044215474, 63.41589976753911], [10.406309305965324, 63.41589935172016], [10.406309258459313, 63.41589892114781], [10.406309802979465, 63.41589856633616], [10.40631006729211, 63.41589815083642], [10.406310842140847, 63.41589788881472], [10.406311391647744, 63.415897531980185], [10.406312321114564, 63.41589738842248], [10.40631310200433, 63.41589712518992], [10.406314095188694, 63.41589711419815], [10.406315031135655, 63.415896970311074], [10.40631599059654, 63.41589709301535], [10.406316989871494, 63.41589708257388], [10.406317827220741, 63.4158973281025], [10.406318786579423, 63.41589745100779], [10.406319413766852, 63.415897794959655], [10.40632024510354, 63.4158980394617], [10.406320600832071, 63.41589844819867], [10.406321222883793, 63.41589879034242], [10.406321272280968, 63.415899223811856], [10.406321624209562, 63.41589963002415], [10.40632136245637, 63.4159000458484], [10.406321409962374, 63.41590047642074], [10.406320865442222, 63.41590083123235], [10.406320601129584, 63.41590124673204], [10.40631982628084, 63.41590150875373], [10.40631927678094, 63.41590186558364], [10.406318347306987, 63.415902009145896], [10.406317566380814, 63.41590227239073], [10.40631657322486, 63.4159022833781], [10.406315637321928, 63.41590242726181], [10.406314677825147, 63.41590230455296], [10.406313678536709, 63.41590231499048], [10.406312841200952, 63.415902069465865], [10.406311881857793, 63.41590194656259], [10.406311254654854, 63.41590160260878], [10.406310423287072, 63.41590135809761], [10.406310067581142, 63.41590094937772], [10.406309445540144, 63.41590060724639], [10.40630939614079, 63.415900173756754], [10.406309044215474, 63.41589976753911]],
                        [[10.406235252437074, 63.41593807335493], [10.40624900373556, 63.41593238693521], [10.406282364016562, 63.415946248044115], [10.40626947515715, 63.415952308516815], [10.406267982069075, 63.41595173482261], [10.406279222705141, 63.41594620665098], [10.406279220143919, 63.41594618114021], [10.40624926692002, 63.415933735843005], [10.40624921868004, 63.4159337375896], [10.406236973691032, 63.41593885019857], [10.406235252437074, 63.41593807335493]],
                        [[10.406259078746235, 63.41594735270413], [10.406259340496085, 63.41594693688587], [10.406259292990072, 63.41594650631423], [10.406259837510223, 63.41594615150318], [10.406260101822879, 63.41594573600411], [10.406260876671608, 63.415945473982845], [10.406261426178487, 63.41594511714892], [10.406262355645325, 63.41594497359146], [10.406263136535117, 63.41594471035933], [10.406264129719457, 63.41594469936758], [10.406265065666362, 63.41594455548073], [10.406266025127307, 63.41594467818481], [10.406267024402307, 63.415944667743354], [10.406267861751504, 63.41594491327156], [10.406268821110148, 63.415945036176645], [10.406269448297612, 63.415945380127944], [10.406270279634327, 63.4159456246296], [10.406270635362842, 63.41594603336586], [10.406271257414554, 63.415946375509044], [10.406271306811727, 63.415946808977786], [10.406271658740323, 63.4159472151894], [10.40627139698713, 63.415947631012955], [10.406271444493134, 63.415948061584565], [10.40627089997299, 63.41594841639561], [10.406270635660338, 63.4159488318946], [10.406269860811598, 63.41594909391586], [10.406269311311716, 63.41594945074518], [10.406268381837746, 63.415949594307186], [10.406267600911564, 63.415949857551595], [10.40626660775562, 63.41594986853895], [10.406265671852713, 63.41595001242242], [10.406264712355906, 63.415949889713744], [10.40626371306745, 63.41594990015126], [10.406262875731713, 63.415949654627056], [10.406261916388564, 63.41594953172399], [10.406261289185613, 63.41594918777075], [10.406260457817831, 63.415948943259984], [10.406260102111903, 63.41594853454077], [10.406259480070904, 63.41594819241001], [10.40625943067155, 63.415947758921085], [10.406259078746235, 63.41594735270413]],
                        [[10.406209113276994, 63.415994937790174], [10.406209375026853, 63.415994521972586], [10.406209327520841, 63.41599409140166], [10.406209872040986, 63.415993736591204], [10.40621013635363, 63.415993321092856], [10.406210911202377, 63.415993059072], [10.406211460709267, 63.41599270223867], [10.406212390176083, 63.415992558681445], [10.406213171065884, 63.415992295449755], [10.406214164250217, 63.415992284458014], [10.406215100197123, 63.41599214057141], [10.40621605965807, 63.41599226327529], [10.406217058933068, 63.415992252833846], [10.40621789628226, 63.41599249836166], [10.406218855640917, 63.415992621266525], [10.40621948282837, 63.41599296521724], [10.406220314165079, 63.41599320971851], [10.406220669893601, 63.415993618454095], [10.406221291945315, 63.415993960596715], [10.406221341342496, 63.41599439406472], [10.40622169327108, 63.41599480027567], [10.40622143151789, 63.415995216098544], [10.406221479023893, 63.41599564666944], [10.40622093450375, 63.41599600147988], [10.406220670191097, 63.415996416978196], [10.406219895342367, 63.41599667899901], [10.40621934584246, 63.41599703582775], [10.406218416368507, 63.415997179389514], [10.40621763544236, 63.41599744263347], [10.406216642286381, 63.41599745362081], [10.406215706383438, 63.41599759750404], [10.406214746886667, 63.415997474795596], [10.40621374759823, 63.41599748523308], [10.406212910262472, 63.41599723970927], [10.406211950919324, 63.4159971168064], [10.406211323716374, 63.41599677285374], [10.406210492348592, 63.415996528343385], [10.406210136642661, 63.41599611962484], [10.406209514601667, 63.41599577749467], [10.406209465202311, 63.415995344006454], [10.406209113276994, 63.415994937790174]]
                        ]
    
    
    R1_unity = R1
    for i in range(len(R1)):
        print("R1 shape{}: {}".format(i, len(R1[i])))
        print("-----------------")
        for j in range(len(R1[i])):
            R1_unity[i][j] = coor_to_ECEF(R1[i][j][0], R1[i][j][1], 8)
            R1_unity[i][j] = R1_unity[i][j] - init_ECEF  
            R1_unity[i][j] = ECEF_to_NED(R1[i][j][0], R1[i][j][1], R1_unity[i][j])
            R1_unity[i][j] = NED_to_BODY(R1_unity[i][j])
            R1_unity[i][j] = BODY_to_UNITY(R1_unity[i][j])
            if j < 10:
                print("[{}, {}, {},]".format(R1_unity[i][j][0], R1_unity[i][j][1], R1_unity[i][j][2]))
    """
    
        
    
    





